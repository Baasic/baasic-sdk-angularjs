!function(e){var r=e.module("baasic.baasicApi",["HALParser"]);r.config(["$provide",function(r){function t(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}(!("withCredentials"in new XMLHttpRequest)||window.ActiveXObject||"ActiveXObject"in window)&&r.decorator("$httpBackend",["$delegate","$q","$rootScope","$window","$document","baasicApp",function(r,a,n,i,s,c){function o(e,r,t){r.requestId=f;var a={proxy:e,callback:t,message:r};d[r.requestId]=a,e.sendMessage(a),f+=1}for(var u=c.all(),p=[],d={},f=0,m=0,l=u.length;l>m;m++){var v=u[m];!function(r){var a=r.get_apiUrl(),n={proxyFrame:[],apiUrlRegex:new RegExp("^"+t(a)),sendMessage:function(e){this.proxyFrame.push[e]}};p.push(n);var i=e.element('<iframe src="'+a+'proxy/angular" style="display:none"></iframe>');i.bind("load",function(){var e=n.proxyFrame;for(n.proxyFrame=this,n.sendMessage=function(e){this.proxyFrame.contentWindow.postMessage(JSON.stringify(e.message),a)};e.length>0;)n.sendMessage(e.shift())}),s.find("body").append(i)}(v)}return e.element(i).bind("message",function(e){var r=e.originalEvent||e,t=JSON.parse(r.data),a=d[t.requestId];a&&r.source==a.proxy.proxyFrame.contentWindow&&(delete d[t.requestId],a.callback(t.status,t.response,t.headersString))}),function(e,t,a,n,i,s,c,u){for(var d=0,f=p.length;f>d;d++){var m=p[d];if(m.apiUrlRegex.test(t))return void o(m,{method:e,url:t,post:a,headers:i,timeout:s,withCredentials:c,responseType:u},n)}r(e,t,a,n,i,s,c,u)}}])}]),function(e,r){"use strict";r.directive("baasicRecaptcha",["baasicRecaptchaService",function(e){return{restrict:"A",link:function(r,t){e.create(t,{theme:"clean"}),r.$on("$destroy",function(){e&&e.destroy()})}}}])}(e,r),function(e,r,t){"use strict";function a(e){return e.substr(1,e.length-2).replace(/(?:(?:\r\n)?[ \t])+/g," ")}function n(e){if(e){var r=e.match(d);if(r&&r.length>0){var n={scheme:r[0]};if(r.length>1){for(var i={},s=1,c=r.length;c>s;s++){var o=r[s].split("=");i[o[0]]=a(o[1])}n.details=i}return n}}return t}function i(e,r){return e.substring(0,r.length)===r}function s(e){var r=e.toLowerCase();return i(r,"http://")||i(r,"https://")}function c(e){return Array.prototype.slice.call(e,1)}function o(r){e.forEach(c(arguments,1),function(e){r[e]=function(t,a){return r(p(a||{},{method:e,url:t}))}})}function u(r){e.forEach(c(arguments,1),function(e){r[e]=function(t,a,n){return r(p(n||{},{method:e,url:t,data:a}))}})}var p=e.extend,d=function(){var e="(?:(?:\\r\\n)?[ \\t])+",r="(?:[\\x21\\x23-\\x27\\x2A\\x2B\\x2D\\x2E\\x30-\\x39\\x3F\\x41-\\x5A\\x5E-\\x7A\\x7C\\x7E]+)",t='"(?:[\\x00-\\x0B\\x0D-\\x21\\x23-\\x5B\\\\x5D-\\x7F]|'+e+'|\\\\[\\x00-\\x7F])*"';return RegExp(r+"(?:=(?:"+t+"|"+r+"))?","g")}(),f=function(e,r,t,a){function i(r){var t=n(r("WWW-Authenticate"));if(t&&"bearer"===t.scheme.toLowerCase()){var i=t.details;if(i&&i.error)switch(i.error){case"invalid_token":var s=a.get_accessToken();a.update_accessToken(null),e.$broadcast("token_error",{token:s,error:i.error,error_description:i.error_description})}}}var c=a.get_apiUrl(),d=function(e){if(e){e.withCredentials=!0,s(e.url)||(e.url=c+e.url);var n=e.headers||(e.headers={});n["Content-Type"]||(n["Content-Type"]="application/json; charset=UTF-8"),n.Accept||(n.Accept="application/hal+json; charset=UTF-8");var o=a.get_accessToken();o&&(n.AUTHORIZATION=o.token_type+" "+o.access_token)}var u=r(e);return u=p(u.then(function(e){if(e.headers){var r=e.headers("Content-Type");r&&-1!==r.toLowerCase().indexOf("application/hal+json")&&(e.data=t.parse(e.data)),i(e.headers)}},function(e){e.headers&&i(e.headers)}).finally(function(){var e=a.get_accessToken();e&&e.sliding_window&&(e.expireTime=(new Date).getTime()+1e3*e.sliding_window,a.update_accessToken(e))}),u)};return o(d,"get","delete","head","jsonp"),u(d,"post","put"),d};r.service("baasicApiHttp",["$rootScope","$http","HALParser","baasicApp",function(e,r,t,a){var n=new t,i=f(e,r,n,a.get());return i.createNew=function(t){return f(e,r,n,t)},i}])}(e,r),function(e,r,t){"use strict";r.service("baasicApiService",["baasicConstants",function(r){function a(r){e.isObject(r)?(e.extend(this,r),r.hasOwnProperty("orderBy")&&r.hasOwnProperty("orderDirection")&&(this.sort=r.orderBy?r.orderBy+"|"+r.orderDirection:null),r.hasOwnProperty("search")&&(this.searchQuery=r.search),r.hasOwnProperty("pageNumber")&&(this.page=r.pageNumber),r.hasOwnProperty("pageSize")&&(this.rpp=r.pageSize)):this.searchQuery=r}function n(a,n){e.isObject(a)?e.extend(this,a):n!==t?this[n]=a:this[r.keyPropertyName]=a}function i(t){t.hasOwnProperty(r.modelPropertyName)?e.extend(this,t):this[r.modelPropertyName]=t}return{findParams:function(e){return new a(e)},getParams:function(e,r){return new n(e,r)},createParams:function(e){return new i(e)},updateParams:function(e){return new i(e)},removeParams:function(e){return new i(e)}}}])}(e,r),r.provider("baasicApp",function(){var r,t={};this.create=function(a,n){var i={apiRootUrl:"api.baasic.local",apiVersion:"beta"},s=MonoSoftware.Baasic.Application.init(a,e.extend(i,n));return t[a]=s,r||(r=s),s},this.$get=function(){return{all:function(){var e=[];for(var r in t)e.push(t[r]);return e},get:function(e){return e?t[e]:r}}}}),function(e,r){"use strict";r.service("baasicLookupRouteService",["baasicUriTemplateService",function(e){return{get:e.parse("lookup/{?embed,fields}")}}])}(e,r),function(e,r,t){"use strict";r.service("baasicLookupService",["baasicApiHttp","baasicApiService","baasicLookupRouteService",function(e,r,a){var n="baasic-lookup-data";return{routeService:a,get:function(i){var s=e.createHttpDefer(),c=JSON.parse(localStorage.getItem(n));return c===t||null===c?e.get(a.get.expand(r.getParams(i))).success(function(e,r,t,a){localStorage.setItem(n,JSON.stringify(e)),s.resolve({data:e,status:r,headers:t,config:a})}).error(function(e,r,t,a){s.reject({data:e,status:r,headers:t,config:a})}):s.resolve({data:c}),s.promise},reset:function(){localStorage.setItem(n,null)}}}])}(e,r),function(e,r){"use strict";r.service("baasicRoleRouteService",["baasicUriTemplateService",function(e){return{find:e.parse("role/{?searchQuery,page,rpp,sort,embed,fields}"),get:e.parse("role/{roleId}/{?embed,fields}"),create:e.parse("role"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicRoleService",["baasicApiHttp","baasicApiService","baasicConstants","baasicRoleRouteService",function(e,r,t,a){return{routeService:a,find:function(t){return e.get(a.find.expand(r.findParams(t)))},get:function(t){return e.get(a.get.expand(r.getParams(t,"roleId")))},create:function(n){return e.post(a.create.expand({}),r.createParams(n)[t.modelPropertyName])},update:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("put").href,n[t.modelPropertyName])},remove:function(a){var n=r.removeParams(a);return e.delete(n[t.modelPropertyName].links("delete").href)}}}])}(e,r),function(e,r){"use strict";r.service("baasicUserRouteService",["baasicUriTemplateService",function(e){return{find:e.parse("user/{?searchQuery,page,rpp,sort,embed,fields}"),get:e.parse("user/{username}/{?embed,fields}"),create:e.parse("user"),activate:e.parse("user/activate/{activationToken}/"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicUserService",["baasicApiHttp","baasicApiService","baasicConstants","baasicUserRouteService",function(e,r,t,a){return{routeService:a,find:function(t){return e.get(a.find.expand(r.findParams(t)))},get:function(t){return e.get(a.get.expand(r.getParams(t,"username")))},create:function(n){return e.post(a.create.expand({}),r.createParams(n)[t.modelPropertyName])},update:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("put").href,n[t.modelPropertyName])},remove:function(a){var n=r.removeParams(a);return e.delete(n[t.modelPropertyName].links("delete").href)},unlock:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("unlock").href,{})},lock:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("lock").href,{})},activate:function(t){var n=r.getParams(t,"activationToken");return e.put(a.activate.expand(n),{})}}}])}(e,r),function(e,r){"use strict";r.constant("baasicConstants",{idPropertyName:"id",keyPropertyName:"key",modelPropertyName:"model"})}(e,r),function(e,r){"use strict";r.service("baasicApplicationSettingsRouteService",["baasicUriTemplateService",function(e){return{get:e.parse("application/{key}/{?embed,fields}"),update:e.parse("application/{key}/"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicApplicationSettingsService",["baasicApiHttp","baasicApiService","baasicConstants","baasicApplicationSettingsRouteService",function(e,r,t,a){return{routeService:a,get:function(t){return e.get(a.get.expand(r.getParams(t))).success(function(e){e.origins=e.origins||[]})},update:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("put").href,n[t.modelPropertyName])}}}])}(e,r),function(e,r){"use strict";r.service("baasicDynamicResourceRouteService",["baasicUriTemplateService",function(e){return{find:e.parse("resource/{resourceName}/{?searchQuery,page,rpp,sort,embed,fields}"),get:e.parse("resource/{resourceName}/{id}/{?embed,fields}"),create:e.parse("resource/{resourceName}"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicDynamicResourceService",["baasicApiHttp","baasicApiService","baasicConstants","baasicDynamicResourceRouteService",function(e,r,t,a){return{routeService:a,find:function(t){return e.get(a.find.expand(r.findParams(t)))},get:function(t){return e.get(a.get.expand(r.getParams(t)))},create:function(n){return e.post(a.create.expand({resourceName:n.resourceName}),r.createParams(n)[t.modelPropertyName])},update:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("put").href,n[t.modelPropertyName])},remove:function(a){var n=r.removeParams(a);return e.delete(n[t.modelPropertyName].links("delete").href)}}}])}(e,r),function(e,r){"use strict";r.service("baasicDynamicSchemaRouteService",["baasicUriTemplateService",function(e){return{find:e.parse("schema/{?searchQuery,page,rpp,sort,embed,fields}"),get:e.parse("schema/{resourceName}/{?embed,fields}"),generateSchema:e.parse("schema/generate"),create:e.parse("schema"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicDynamicSchemaService",["baasicApiHttp","baasicApiService","baasicConstants","baasicDynamicSchemaRouteService",function(e,r,t,a){return{routeService:a,find:function(t){return e.get(a.find.expand(r.findParams(t)))},get:function(t){return e.get(a.get.expand(r.getParams(t,"resourceName")))},create:function(n){return e.post(a.create.expand({}),r.createParams(n)[t.modelPropertyName])},update:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("put").href,n[t.modelPropertyName])},remove:function(a){var n=r.removeParams(a);return e.delete(n[t.modelPropertyName].links("delete").href)},generateSchema:function(n){return e.post(a.generateSchema.expand({}),r.createParams(n)[t.modelPropertyName])}}}])}(e,r),function(e,r){"use strict";r.service("baasicKeyValueRouteService",["baasicUriTemplateService",function(e){return{find:e.parse("keyvalue/{?searchQuery,page,rpp,sort,embed,fields}"),get:e.parse("keyvalue/{key}/{?embed,fields}"),create:e.parse("keyvalue"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicKeyValueService",["baasicApiHttp","baasicApiService","baasicConstants","baasicKeyValueRouteService",function(e,r,t,a){return{routeService:a,find:function(t){return e.get(a.find.expand(r.findParams(t)))},get:function(t){return e.get(a.get.expand(r.getParams(t)))},create:function(n){return e.post(a.create.expand(),r.createParams(n)[t.modelPropertyName])},update:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("put").href,n[t.modelPropertyName])},remove:function(a){var n=r.removeParams(a);return e.delete(n[t.modelPropertyName].links("delete").href)}}}])}(e,r),function(e,r){"use strict";r.service("baasicValueSetItemRouteService",["baasicUriTemplateService",function(e){return{find:e.parse("valuesetitems/set/{setName}/{?searchQuery,page,rpp,sort,embed,fields}"),get:e.parse("valuesetitems/set/{setName}/item/{itemKey}/{?embed,fields}"),create:e.parse("valuesetitems"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicValueSetItemService",["baasicApiHttp","baasicApiService","baasicConstants","baasicValueSetItemRouteService",function(e,r,t,a){return{routeService:a,find:function(t){return e.get(a.find.expand(r.findParams(t)))},get:function(t){return e.get(a.get.expand(r.getParams(t)))},create:function(n){return e.post(a.create.expand(),r.createParams(n)[t.modelPropertyName])},update:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("put").href,n[t.modelPropertyName])},remove:function(a){var n=r.removeParams(a);return e.delete(n[t.modelPropertyName].links("delete").href)}}}])}(e,r),function(e,r){"use strict";r.service("baasicValueSetRouteService",["baasicUriTemplateService",function(e){return{find:e.parse("valueset/{?searchQuery,page,rpp,sort,embed,fields}"),get:e.parse("valueset/{setName}/{?embed,fields}"),create:e.parse("valueset"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicValueSetService",["baasicApiHttp","baasicApiService","baasicConstants","baasicValueSetRouteService",function(e,r,t,a){return{routeService:a,find:function(t){return e.get(a.find.expand(r.findParams(t)))},get:function(t){return e.get(a.get.expand(r.getParams(t,"setName")))},create:function(n){return e.post(a.create.expand({}),r.createParams(n)[t.modelPropertyName])},update:function(a){var n=r.updateParams(a);return e.put(n[t.modelPropertyName].links("put").href,n[t.modelPropertyName])},remove:function(a){var n=r.removeParams(a);return e.delete(n[t.modelPropertyName].links("delete").href)}}}])}(e,r),function(e,r,t){"use strict";var a={};r.service("baasicAuthorizationService",["$rootScope","baasicApp",function(r,n){var i=n.get(),s=i.get_apiKey();return a[s]={},{getUser:function(){var e=i.get_user();return r.user===t&&e.user!==t&&(r.user=e.user),e.user},setUser:function(e){if(e){var t=e.accessToken;delete e.accessToken,i.set_user(e,t),e.isAuthenticated=!0,r.user=e}else i.set_user(null),this.resetPermissions(),r.user={isAuthenticated:!1}},updateUser:function(r){r.accessToken||(r.accessToken=this.getAccessToken());var t=this.getUser();e.extend(t,r),this.setUser(t)},getAccessToken:function(){return i.get_accessToken()},resetPermissions:function(){a[s]={}},hasPermission:function(e){if(a[s].hasOwnProperty(e))return a[s][e];var r=this.getUser();if(r!==t){var n=!1;if(r.permissions){var i=e.split(".");if(i.length>0){var c=i[0],o=r.permissions[c];if(o)if(i.length>1){for(var u=i[1].toLowerCase(),p=0;p<o.length;p++)if(o[p].toLowerCase()==u){n=!0;break}}else n=!0}}return a[s][e]=n,n}}}}])}(e,r),function(e,r){"use strict";r.service("baasicLoginRouteService",["baasicUriTemplateService",function(e){return{login:e.parse("/login/{?embed,fields,options}"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicLoginService",["baasicApiHttp","baasicLoginRouteService",function(r,t){return{routeService:t,login:function(a){var n=e.copy(a),i="grant_type=password&username="+n.username+"&password="+n.password;if(n.options){var s=n.options;e.isArray(s)&&(n.options=s.join())}return r({url:t.login.expand(n),method:"POST",data:i,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}})},loadUserData:function(e){return e=e||{},r.get(t.login.expand(e),{headers:{Accept:"application/json; charset=UTF-8"}})},logout:function(e,a){return r({url:t.login.expand({}),method:"DELETE",data:{token:e,type:a}})}}}])}(e,r),function(e,r){"use strict";r.service("baasicPasswordRecoveryRouteService",["baasicUriTemplateService",function(e){return{passwordRecovery:e.parse("/RecoverPassword"),changePassword:e.parse("/RecoverPassword/user/{username}/change"),parse:e.parse}}])}(e,r),function(e,r){"use strict";r.service("baasicPasswordRecoveryService",["baasicApiHttp","baasicPasswordRecoveryRouteService",function(e,r){return{routeService:r,requestReset:function(t){return e({url:r.passwordRecovery.expand({}),method:"POST",data:t})},reset:function(t){return e({url:r.passwordRecovery.expand({}),method:"PUT",data:t})},change:function(t,a){return e({url:r.changePassword.expand({username:t}),method:"PUT",data:a})}}}])}(e,r),function(e,r){"use strict";r.service("baasicPermissionsRouteService",["baasicUriTemplateService",function(e){return{find:function(r){return e.parse("permissions/section/"+r+"/{?searchQuery,sort}")},get:function(r){return e.parse("permissions/section/"+r+"/{id}")},getActions:e.parse("permissions/actions/{?searchQuery,sort}"),getRoles:e.parse("role/{?searchQuery,page,rpp,sort}"),getUsers:e.parse("user/{?searchQuery,page,rpp,sort}"),create:e.parse("permissions/"),parse:e.parse}}])}(e,r),function(e,r,t){"use strict";r.service("baasicPermissionsService",["$q","$filter","baasicApiHttp","baasicApiService","baasicConstants","baasicPermissionsRouteService","baasicAuthorizationService",function(r,a,n,i,s,c,o){function u(e){return e===t||null===e||""===e}function p(e){return n.get(c.getRoles.expand(i.findParams(e)))}function d(e){return n.get(c.getUsers.expand(i.findParams(e)))}function f(e){return e.replace(/^./,function(e){return e.toLowerCase()})}var m=a("orderBy"),l=a("filter");return{routeService:c,find:function(e,r){return n.get(c.find(e).expand(i.findParams(r)))},get:function(e,r){return n.get(c.get(e).expand(i.getParams(r)))},getActions:function(e){return n.get(c.getActions.expand(i.findParams(e)))},getPermissionSubjects:function(t){var a=[],n=d(t).success(function(r){e.forEach(r.item,function(r){var t={name:r.username,role:""};e.extend(t,r),a.push(t)})}),i=p(t).success(function(r){e.forEach(r.item,function(r){var t={name:r.name,roleName:r.name,username:""};e.extend(t,r),a.push(t)})});return r.all([n,i]).then(function(){return m(a,"name")})},create:function(e){return n.post(c.create.expand(),i.createParams(e)[s.modelPropertyName])},remove:function(e){var r=i.removeParams(e),t=e.actions[0],a=u(e.role)?"User":"Role";return n.delete(r[s.modelPropertyName].links("delete"+t.abrv+a).href)},preparePermissions:function(r,a,n,i){var s=this,c=e.copy(l(i,function(e){return u(r.pagingInfo.search)?!0:e.name.indexOf(r.pagingInfo.search)>-1}));return e.forEach(n,function(r){e.forEach(a,function(t){var a=l(r.actions,function(e){return e.abrv===t.abrv});if(0===a.length){var n={checked:!1};e.extend(n,t),r.actions.push(n)}else e.forEach(a,function(e){e.checked=!0})}),r.actions=m(r.actions,"name");var n=s.findPermission(r,c);n===t?c.push(r):e.extend(n,r)}),c},createPermission:function(r,t,a){var n={dirty:!0,role:a.roleName,username:a.userName,section:r,actions:[]};return e.forEach(t,function(r){var t={checked:!1};e.extend(t,r),n.actions.push(t)}),n},findPermission:function(e,r){for(var a=0;a<r.length;a++){var n=r[a];if(n.section===e.section&&(!u(n.role)&&!u(e.role)&&n.role===e.role||!u(n.username)&&!u(e.username)&&n.username===e.username))return n}return t},exists:function(e,r){return!(this.findPermission(e,r)===t)},togglePermission:function(r,t){var a={};e.extend(a,r),a.actions=[t];var n;return(n=t.checked?this.remove:this.create)(a)},getModulePermissions:function(e){var r={update:o.hasPermission(f(e)+".update"),create:o.hasPermission(f(e)+".create"),remove:o.hasPermission(f(e)+".delete"),read:o.hasPermission(f(e)+".read")};return r}}}])}(e,r),function(e,r){"use strict";r.service("baasicRecaptchaService",["recaptchaKey",function(e){return{create:function(r,t){var a=r.attr("id");a||(a="recaptcha-"+1e4*Math.random(),r.attr("id",a)),Recaptcha.create(e,a,t)},challenge:function(){return Recaptcha.get_challenge()},response:function(){return Recaptcha.get_response()},reload:function(){Recaptcha.reload()},destroy:function(){Recaptcha.destroy()}}}])}(e,r),function(e,r){"use strict";r.service("baasicUriTemplateService",[function(){return{parse:function(e){return UriTemplate.parse(e)},constructTemplateUrl:function(e,r){if(!e||!e.templateText||!e.defaultUrl)throw"Invalid template configuration.";if(e.templateText){var t=null,a=null,n=r.orderBy?r.orderBy+"|"+r.orderDirection:null,i={page:r.pageNumber,rpp:r.pageSize,sort:n,searchQuery:r.search};if(e.additionalParams)for(var s in e.additionalParams){if(i[s])throw"Property"+s+" already exists in default expand configuration";i[s]=e.additionalParams[s]}t=e.templateText.expand(i),a=t.indexOf(e.defaultUrl),url=t.substr(a)}else url=defaultUrl;return url}}}])}(e,r)}(angular);